<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  <title itemprop="name">run_classifier.py逐行注释 | 彩音のBlog</title>
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * 邮箱信息之类的东西可以填在这里，这些js变量基本都作用于sakura-app.js
   * 这样的设置仅是为了方便在基于PHP开发的主题中设置js变量，既然移植到了Node上，我想或许可以精简这一逻辑吧
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "桜の彩音";
  mashiro_option.author_name = "彩音";
  mashiro_option.site_url = "/index.html";
  mashiro_option.v_appId = "lYNRGPGqY6jaXXBdu5JwvBHN-MdYXbMMI";
  mashiro_option.v_appKey = "wJkDCj8fLwzhY7dC7QXfQe1V";
  mashiro_option.mathjax = "1";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "https://s1.ax1x.com/2020/07/13/UtQmM6.jpg,https://s1.ax1x.com/2020/07/13/UtQSMV.jpg,https://s1.ax1x.com/2020/07/03/NjoeaT.jpg,https://s1.ax1x.com/2020/07/03/NjIDET.jpg,https://s1.ax1x.com/2020/07/03/NjIXrt.jpg,https://s1.ax1x.com/2020/07/03/NjouiF.jpg,https://s1.ax1x.com/2020/07/03/NjIb2d.jpg,https://s1.ax1x.com/2020/07/03/NjoMRJ.jpg,https://s1.ax1x.com/2020/07/13/UtQVR1.jpg,https://s1.ax1x.com/2020/07/13/UtQ3id.jpg".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('朋友，IE浏览器未适配哦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;}.author-profile i,.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
</head>
</html>
<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit">
  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop filter-dot">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
        <a href="/index.html">
          <img src="https://s2.ax1x.com/2020/02/10/14XAGd.jpg">
        </a>
      </div>
      <div class="header-info">
        <p>施工中。。。</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="http://github.com/yuk1n0sh1ta" target="_blank" class="social-github" title="github">
                    <img src="/img/social/github.svg">
                  </a>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name="" src="" width="auto" preload="auto">
    </video>
    <div id="video-btn" class="loadvideo videolive">
    </div>
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="centerbg">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <span class="sakurasono">桜の</span>
            <span class="shironeko">彩音</span>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
                    首页
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
                    归档
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/学习/">
                          <i class="fa fa-code" aria-hidden="true"></i>
                          学习
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/生活/">
                          <i class="fa fa-file-text-o" aria-hidden="true"></i>
                          生活
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
                    清单
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/musiclist/">
                          <i class="fa fa-headphones" aria-hidden="true"></i>
                          歌单
                        </a>
                      </li>
                    
                      <li>
                        <a href="/gallery/">
                          <i class="fa fa-photo" aria-hidden="true"></i>
                          美术
                        </a>
                      </li>
                    
                      <li>
                        <a href="/photo/">
                          <i class="fa fa-film" aria-hidden="true"></i>
                          相册
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
                    关于
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/about/">
                          <i class="fa fa-meetup" aria-hidden="true"></i>
                          我
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>

  <div class="pattern-center single-center">
    <!-- 有配图默认渲染第一张 -->
    <div class="pattern-attachment-img lazyload" style="background-image: url(https://s2.ax1x.com/2020/02/10/14XAGd.jpg);" src="https://s1.ax1x.com/2020/07/13/UtQmM6.jpg,https://s1.ax1x.com/2020/07/13/UtQSMV.jpg,https://s1.ax1x.com/2020/07/03/NjoeaT.jpg,https://s1.ax1x.com/2020/07/03/NjIDET.jpg,https://s1.ax1x.com/2020/07/03/NjIXrt.jpg,https://s1.ax1x.com/2020/07/03/NjIb2d.jpg,https://s1.ax1x.com/2020/07/13/UtQVR1.jpg,https://s1.ax1x.com/2020/07/13/UtQ3id.jpg,https://s2.ax1x.com/2020/02/10/14XAGd.jpg" data-src="https://s2.ax1x.com/2020/02/10/14XAGd.jpg">
    </div>
    <header class="pattern-header single-header">
      <h1 class="entry-title">
      run_classifier.py逐行注释</h1>
      <p class="entry-census">
        <span>
          <a href="">
            <img src="https://s2.ax1x.com/2020/02/10/14XAGd.jpg">
          </a>
        </span>
        <span>
          <a href="">彩音</a>
        </span>
        <whitefont>
        ·</whitefont>
        <whitefont>2020-11-28<whitefont>
        ·</whitefont>
      <whitefont id="busuanzi_value_page_pv"></whitefont><whitefont>次阅读</whitefont></p>
    </header>
  </div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- 套嵌目录使用（主要为了支援评论）-->
        
        <div class="entry-content">
          <ul>
<li>本文为BERT的run_classifier.py模块，即分类模块，进行逐行注释。</li>
</ul>
<h1 id="run-classifier-py"><a href="#run-classifier-py" class="headerlink" title="run_classifier.py"></a>run_classifier.py</h1><h2 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h2><pre><code class="python">&quot;&quot;&quot;BERT finetuning runner.&quot;&quot;&quot;

from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import collections
import csv
import os
import modeling
import optimization
import tokenization
import tensorflow as tf
</code></pre>
<h2 id="参数定义"><a href="#参数定义" class="headerlink" title="参数定义"></a>参数定义</h2><pre><code class="python">flags = tf.flags
FLAGS = flags.FLAGS
## Required parameters
flags.DEFINE_string(
    &quot;data_dir&quot;, None,
    &quot;The input data dir. Should contain the .tsv files (or other data files) &quot;
    &quot;for the task.&quot;)
flags.DEFINE_string(
    &quot;bert_config_file&quot;, None,
    &quot;The config json file corresponding to the pre-trained BERT model. &quot;
    &quot;This specifies the model architecture.&quot;)
flags.DEFINE_string(&quot;task_name&quot;, None, &quot;The name of the task to train.&quot;)
flags.DEFINE_string(&quot;vocab_file&quot;, None,
                    &quot;The vocabulary file that the BERT model was trained on.&quot;)
flags.DEFINE_string(
    &quot;output_dir&quot;, None,
    &quot;The output directory where the model checkpoints will be written.&quot;)
## Other parameters
flags.DEFINE_string(
    &quot;init_checkpoint&quot;, None,
    &quot;Initial checkpoint (usually from a pre-trained BERT model).&quot;)
flags.DEFINE_bool(
    &quot;do_lower_case&quot;, True,
    &quot;Whether to lower case the input text. Should be True for uncased &quot;
    &quot;models and False for cased models.&quot;)
flags.DEFINE_integer(
    &quot;max_seq_length&quot;, 128,
    &quot;The maximum total input sequence length after WordPiece tokenization. &quot;
    &quot;Sequences longer than this will be truncated, and sequences shorter &quot;
    &quot;than this will be padded.&quot;)
flags.DEFINE_bool(&quot;do_train&quot;, False, &quot;Whether to run training.&quot;)
flags.DEFINE_bool(&quot;do_eval&quot;, False, &quot;Whether to run eval on the dev set.&quot;)
flags.DEFINE_bool(
    &quot;do_predict&quot;, False,
    &quot;Whether to run the model in inference mode on the test set.&quot;)
flags.DEFINE_integer(&quot;train_batch_size&quot;, 32, &quot;Total batch size for training.&quot;)
flags.DEFINE_integer(&quot;eval_batch_size&quot;, 8, &quot;Total batch size for eval.&quot;)
flags.DEFINE_integer(&quot;predict_batch_size&quot;, 8, &quot;Total batch size for predict.&quot;)
flags.DEFINE_float(&quot;learning_rate&quot;, 5e-5, &quot;The initial learning rate for Adam.&quot;)
flags.DEFINE_float(&quot;num_train_epochs&quot;, 3.0,
                   &quot;Total number of training epochs to perform.&quot;)
flags.DEFINE_float(
    &quot;warmup_proportion&quot;, 0.1,
    &quot;Proportion of training to perform linear learning rate warmup for. &quot;
    &quot;E.g., 0.1 = 10% of training.&quot;)
flags.DEFINE_integer(&quot;save_checkpoints_steps&quot;, 1000,
                     &quot;How often to save the model checkpoint.&quot;)
flags.DEFINE_integer(&quot;iterations_per_loop&quot;, 1000,
                     &quot;How many steps to make in each estimator call.&quot;)
flags.DEFINE_bool(&quot;use_tpu&quot;, False, &quot;Whether to use TPU or GPU/CPU.&quot;)
tf.flags.DEFINE_string(
    &quot;tpu_name&quot;, None,
    &quot;The Cloud TPU to use for training. This should be either the name &quot;
    &quot;used when creating the Cloud TPU, or a grpc://ip.address.of.tpu:8470 &quot;
    &quot;url.&quot;)
tf.flags.DEFINE_string(
    &quot;tpu_zone&quot;, None,
    &quot;[Optional] GCE zone where the Cloud TPU is located in. If not &quot;
    &quot;specified, we will attempt to automatically detect the GCE project from &quot;
    &quot;metadata.&quot;)
tf.flags.DEFINE_string(
    &quot;gcp_project&quot;, None,
    &quot;[Optional] Project name for the Cloud TPU-enabled project. If not &quot;
    &quot;specified, we will attempt to automatically detect the GCE project from &quot;
    &quot;metadata.&quot;)
tf.flags.DEFINE_string(&quot;master&quot;, None, &quot;[Optional] TensorFlow master URL.&quot;)
flags.DEFINE_integer(
    &quot;num_tpu_cores&quot;, 8,
    &quot;Only used if `use_tpu` is True. Total number of TPU cores to use.&quot;)
</code></pre>
<p>tf.flags是tf.app.flags的新版，使用方法见 <a href="https://abhisheksaurabh1985.github.io/2017-12-30-flags-in-python-tf" target="_blank" rel="noopener">https://abhisheksaurabh1985.github.io/2017-12-30-flags-in-python-tf</a> 。flags的引入可以让使用者在cmd中直接操作自定义参数，比如：<br><code>python run_classifier.py --do_train True</code><br>flags的引入还可以在程序全局使用FLAGS.do_train返回该参数的值。</p>
<p>可自定义的参数如下：</p>
<ol>
<li>输入文件目录（训练，验证，测试用）</li>
<li>BERT配置文件位置（json格式）</li>
<li>任务名称（对应不同的测试数据集）</li>
<li>词汇文件位置（txt格式）</li>
<li>输出结果目录（将会包括一些checkpoint）</li>
<li>初始checkpoint（可继承自预训练BERT模型）</li>
<li>单样本序列长度最大值定义（默认128，超出截断，不足补足）</li>
<li>训练轮赋能</li>
<li>验证轮赋能</li>
<li>预测轮赋能</li>
<li>训练轮并行样本数（默认32）</li>
<li>验证轮并行样本数（默认8）</li>
<li>预测轮并行样本数（默认8）</li>
<li>学习率（默认5e-5）</li>
<li>训练轮数（默认3）</li>
<li>热身比例（默认0.1）</li>
<li>checkpoints保存频率（默认1000步保存一次）</li>
<li>iterations_per_loop指使用TPU时每轮循环的迭代步数</li>
<li>6个TPU相关的配置</li>
</ol>
<h2 id="InputExample"><a href="#InputExample" class="headerlink" title="InputExample"></a>InputExample</h2><pre><code class="python">class InputExample(object):
  &quot;&quot;&quot;A single training/test example for simple sequence classification.&quot;&quot;&quot;
  def __init__(self, guid, text_a, text_b=None, label=None):
    &quot;&quot;&quot;Constructs a InputExample.
    Args:
      guid: Unique id for the example.
      text_a: string. The untokenized text of the first sequence. For single
        sequence tasks, only this sequence must be specified.
      text_b: (Optional) string. The untokenized text of the second sequence.
        Only must be specified for sequence pair tasks.
      label: (Optional) string. The label of the example. This should be
        specified for train and dev examples, but not for test examples.
    &quot;&quot;&quot;
    self.guid = guid
    self.text_a = text_a
    self.text_b = text_b
    self.label = label
</code></pre>
<p>该类用于初始化输入样本。<br>其中，<strong>init</strong>的四个参数：</p>
<ol>
<li>guid：样本的唯一识别id</li>
<li>text_a：sentence-pair的首句</li>
<li>text_b：sentence-pair的次句（可以没有）</li>
<li>label：该样本的标签/真值。</li>
</ol>
<h2 id="PaddingInputExample"><a href="#PaddingInputExample" class="headerlink" title="PaddingInputExample"></a>PaddingInputExample</h2><pre><code class="python">class PaddingInputExample(object):
  &quot;&quot;&quot;Fake example so the num input examples is a multiple of the batch size.
  When running eval/predict on the TPU, we need to pad the number of examples
  to be a multiple of the batch size, because the TPU requires a fixed batch
  size. The alternative is to drop the last batch, which is bad because it means
  the entire output data won&#39;t be generated.
  We use this class instead of `None` because treating `None` as padding
  battches could cause silent errors.
  &quot;&quot;&quot;
</code></pre>
<p>当样本数不够一个batch时，该类用来充数（padding）。</p>
<h2 id="InputFeatures"><a href="#InputFeatures" class="headerlink" title="InputFeatures"></a>InputFeatures</h2><pre><code class="python">class InputFeatures(object):
  &quot;&quot;&quot;A single set of features of data.&quot;&quot;&quot;
  def __init__(self,
               input_ids,
               input_mask,
               segment_ids,
               label_id,
               is_real_example=True):
    self.input_ids = input_ids
    self.input_mask = input_mask
    self.segment_ids = segment_ids
    self.label_id = label_id
    self.is_real_example = is_real_example
</code></pre>
<p>该类用于初始化输入特征，将输入的raw数据转换成BERT可用的数据。<br>其中<strong>init</strong>的5个参数：</p>
<ol>
<li>input_ids：输入id，模型会在之后将token通过vocab.txt转化成整数id。</li>
<li>input_mask：输入掩码，用一个包含1，0的列表指示/真token/伪token（padding的token）/。</li>
<li>segment_ids：段落id，用一个包含0，1的列表指示/首句/次句/。（BERT中的E_a、E_b）</li>
<li>label_id：标签id，用[0, n-1]编号n种标签。</li>
<li>is_real_example：指示是否为真样本的布尔值（存在充数的样本）。</li>
</ol>
<h2 id="DataProcessor"><a href="#DataProcessor" class="headerlink" title="DataProcessor"></a>DataProcessor</h2><pre><code class="python">class DataProcessor(object):
  &quot;&quot;&quot;Base class for data converters for sequence classification data sets.&quot;&quot;&quot;
  def get_train_examples(self, data_dir):
    &quot;&quot;&quot;Gets a collection of `InputExample`s for the train set.&quot;&quot;&quot;
    raise NotImplementedError()
  def get_dev_examples(self, data_dir):
    &quot;&quot;&quot;Gets a collection of `InputExample`s for the dev set.&quot;&quot;&quot;
    raise NotImplementedError()
  def get_test_examples(self, data_dir):
    &quot;&quot;&quot;Gets a collection of `InputExample`s for prediction.&quot;&quot;&quot;
    raise NotImplementedError()
  def get_labels(self):
    &quot;&quot;&quot;Gets the list of labels for this data set.&quot;&quot;&quot;
    raise NotImplementedError()
  @classmethod
  def _read_tsv(cls, input_file, quotechar=None):
    &quot;&quot;&quot;Reads a tab separated value file.&quot;&quot;&quot;
    with tf.gfile.Open(input_file, &quot;r&quot;) as f:
      reader = csv.reader(f, delimiter=&quot;\t&quot;, quotechar=quotechar)
      lines = []
      for line in reader:
        lines.append(line)
      return lines
</code></pre>
<p>该类是之后出现的多个特化数据处理器的父类。<br>定义的几个方法：</p>
<ol>
<li>get_train_examples：用于特化数据处理器获取训练集样本。</li>
<li>get_dev_examples：用于特化数据处理器获取验证集样本。</li>
<li>get_test_examples：用于特化数据处理器获取测试集样本。</li>
<li>get_labels：用于特化数据处理器获取标签。</li>
<li>_read_tsv：用于特化数据处理器将tsv/csv类型文件转换为列表。</li>
</ol>
<h2 id="MrpcProcessor"><a href="#MrpcProcessor" class="headerlink" title="MrpcProcessor"></a>MrpcProcessor</h2><pre><code class="python">class MrpcProcessor(DataProcessor):
  &quot;&quot;&quot;Processor for the MRPC data set (GLUE version).&quot;&quot;&quot;
  def get_train_examples(self, data_dir):
    &quot;&quot;&quot;See base class.&quot;&quot;&quot;
    return self._create_examples(
        self._read_tsv(os.path.join(data_dir, &quot;train.tsv&quot;)), &quot;train&quot;)
  def get_dev_examples(self, data_dir):
    &quot;&quot;&quot;See base class.&quot;&quot;&quot;
    return self._create_examples(
        self._read_tsv(os.path.join(data_dir, &quot;dev.tsv&quot;)), &quot;dev&quot;)
  def get_test_examples(self, data_dir):
    &quot;&quot;&quot;See base class.&quot;&quot;&quot;
    return self._create_examples(
        self._read_tsv(os.path.join(data_dir, &quot;test.tsv&quot;)), &quot;test&quot;)
  def get_labels(self):
    &quot;&quot;&quot;See base class.&quot;&quot;&quot;
    return [&quot;0&quot;, &quot;1&quot;]
  def _create_examples(self, lines, set_type):
    &quot;&quot;&quot;Creates examples for the training and dev sets.&quot;&quot;&quot;
    examples = []
    for (i, line) in enumerate(lines):
      if i == 0:
        continue    #跳过第一行，第一行包含表头信息，不包含样本。
      guid = &quot;%s-%s&quot; % (set_type, i)
      text_a = tokenization.convert_to_unicode(line[3])
      text_b = tokenization.convert_to_unicode(line[4])
      if set_type == &quot;test&quot;:
        label = &quot;0&quot;
      else:
        label = tokenization.convert_to_unicode(line[0])
      examples.append(
          InputExample(guid=guid, text_a=text_a, text_b=text_b, label=label))
    return examples
</code></pre>
<p>该类用于文件输入并将数据转化为class InputExample(object)，并写入列表examples。该类是DataProcessor的子类，继承DataProcessor的相关方法。</p>
<p>类似的，还有：<br>class XnliProcessor(DataProcessor)<br>class MnliProcessor(DataProcessor)<br>class ColaProcessor(DataProcessor)</p>
<p>在我们需要处理自己的数据集时，需要自行创建一个自己的数据处理器，并根据数据集的格式对数据进行处理得到InputExample类需要的四个参数guid=guid, text_a=text_a, text_b=text_b, label=label。</p>
<h2 id="convert-single-example"><a href="#convert-single-example" class="headerlink" title="convert_single_example"></a>convert_single_example</h2><pre><code class="python">def convert_single_example(ex_index, example, label_list, max_seq_length,
                           tokenizer):
  &quot;&quot;&quot;Converts a single `InputExample` into a single `InputFeatures`.&quot;&quot;&quot;

  # 若输入的example为充数的样本，
  # 则将InputFeatures的前4个参数设为相应长度的0的列表，将is_real_example设为假。
  if isinstance(example, PaddingInputExample):
    return InputFeatures(
        input_ids=[0] * max_seq_length,
        input_mask=[0] * max_seq_length,
        segment_ids=[0] * max_seq_length,
        label_id=0,
        is_real_example=False)

  # 建立一个{[标签]: 标签序号}的字典
  label_map = {}
  for (i, label) in enumerate(label_list):
    label_map[label] = i

  # 将首句和次句Tokenize并截短
  tokens_a = tokenizer.tokenize(example.text_a)
  tokens_b = None
  if example.text_b:
    tokens_b = tokenizer.tokenize(example.text_b)
  if tokens_b:
    # Modifies `tokens_a` and `tokens_b` in place so that the total
    # length is less than the specified length.
    # Account for [CLS], [SEP], [SEP] with &quot;- 3&quot;
    # 超过阈值则首句次句轮流pop一个token
    _truncate_seq_pair(tokens_a, tokens_b, max_seq_length - 3)
  else:
    # Account for [CLS] and [SEP] with &quot;- 2&quot;
    # 超过阈值则直接截短取前端
    if len(tokens_a) &gt; max_seq_length - 2:
      tokens_a = tokens_a[0:(max_seq_length - 2)]

  # The convention in BERT is:
  # (a) For sequence pairs:
  #  tokens:   [CLS] is this jack ##son ##ville ? [SEP] no it is not . [SEP]
  #  type_ids: 0     0  0    0    0     0       0 0     1  1  1  1   1 1
  # (b) For single sequences:
  #  tokens:   [CLS] the dog is hairy . [SEP]
  #  type_ids: 0     0   0   0  0     0 0
  #
  # Where &quot;type_ids&quot; are used to indicate whether this is the first
  # sequence or the second sequence. The embedding vectors for `type=0` and
  # `type=1` were learned during pre-training and are added to the wordpiece
  # embedding vector (and position vector). This is not *strictly* necessary
  # since the [SEP] token unambiguously separates the sequences, but it makes
  # it easier for the model to learn the concept of sequences.
  #
  # For classification tasks, the first vector (corresponding to [CLS]) is
  # used as the &quot;sentence vector&quot;. Note that this only makes sense because
  # the entire model is fine-tuned.
  tokens = []
  segment_ids = []

  # 为token添加[CLS]以及[SEP]
  # 若存在句子对，则将两个句子级联为tokens。
  # 为segment_ids根据句子的前后添加指示，0表示首句，1表示次句。
  tokens.append(&quot;[CLS]&quot;)
  segment_ids.append(0)
  for token in tokens_a:
    tokens.append(token)
    segment_ids.append(0)
  tokens.append(&quot;[SEP]&quot;)
  segment_ids.append(0)
  if tokens_b:
    for token in tokens_b:
      tokens.append(token)
      segment_ids.append(1)
    tokens.append(&quot;[SEP]&quot;)
    segment_ids.append(1)

  # 将tokens通过vocab.txt转换为整数input_ids
  input_ids = tokenizer.convert_tokens_to_ids(tokens)

  # The mask has 1 for real tokens and 0 for padding tokens. Only real
  # tokens are attended to.
  # 用掩码1表示真token，0表示充数的token。
  input_mask = [1] * len(input_ids)
  # Zero-pad up to the sequence length.
  # 若input_ids长度小于max_seq_length，则用0充数。
  while len(input_ids) &lt; max_seq_length:
    input_ids.append(0)
    input_mask.append(0)
    segment_ids.append(0)

  # 断言函数判断是否相等，否则raise错误
  assert len(input_ids) == max_seq_length
  assert len(input_mask) == max_seq_length
  assert len(segment_ids) == max_seq_length

  # 从字典label_map中找到example.label的序号id
  label_id = label_map[example.label]

  # 打印所有样本中前5个样本的信息
  if ex_index &lt; 5:
    tf.logging.info(&quot;*** Example ***&quot;)
    tf.logging.info(&quot;guid: %s&quot; % (example.guid))
    tf.logging.info(&quot;tokens: %s&quot; % &quot; &quot;.join(
        [tokenization.printable_text(x) for x in tokens]))
    tf.logging.info(&quot;input_ids: %s&quot; % &quot; &quot;.join([str(x) for x in input_ids]))
    tf.logging.info(&quot;input_mask: %s&quot; % &quot; &quot;.join([str(x) for x in input_mask]))
    tf.logging.info(&quot;segment_ids: %s&quot; % &quot; &quot;.join([str(x) for x in segment_ids]))
    tf.logging.info(&quot;label: %s (id = %d)&quot; % (example.label, label_id))

  # 返回包含5个变量的InputFeatures类
  feature = InputFeatures(
      input_ids=input_ids,
      input_mask=input_mask,
      segment_ids=segment_ids,
      label_id=label_id,
      is_real_example=True)
  return feature
</code></pre>
<p>该类用于将数据处理器返回的多个InputExample类中的单个InputExample转换为InputFeatures类。</p>
<h2 id="file-based-convert-examples-to-features"><a href="#file-based-convert-examples-to-features" class="headerlink" title="file_based_convert_examples_to_features"></a>file_based_convert_examples_to_features</h2><pre><code class="python">def file_based_convert_examples_to_features(
    examples, label_list, max_seq_length, tokenizer, output_file):
  &quot;&quot;&quot;Convert a set of `InputExample`s to a TFRecord file.&quot;&quot;&quot;

  # TFRecordWriter初始化
  writer = tf.python_io.TFRecordWriter(output_file)

  # 循环写入每个样本的features
  for (ex_index, example) in enumerate(examples):
    # 进度条（每10000提示一次）
    if ex_index % 10000 == 0:
      tf.logging.info(&quot;Writing example %d of %d&quot; % (ex_index, len(examples)))
    # 将InputExample转换为InputFeatures
    feature = convert_single_example(ex_index, example, label_list,
                                     max_seq_length, tokenizer)
    # 建立整型的特征集，特征集以字典形式存在：
    # int64_list {
    #   value: 0
    #   value: 1
    #   value: ...
    # }
    def create_int_feature(values):
      f = tf.train.Feature(int64_list=tf.train.Int64List(value=list(values)))
      return f
    # 建立一个有序字典
    features = collections.OrderedDict()
    # 建立5个整型特征集
    features[&quot;input_ids&quot;] = create_int_feature(feature.input_ids)
    features[&quot;input_mask&quot;] = create_int_feature(feature.input_mask)
    features[&quot;segment_ids&quot;] = create_int_feature(feature.segment_ids)
    features[&quot;label_ids&quot;] = create_int_feature([feature.label_id])
    features[&quot;is_real_example&quot;] = create_int_feature(
        [int(feature.is_real_example)])
    # 建立嵌套字典存储features
    # features {
    #   feature {
    #     key: &quot;input_ids&quot;
    #     value {
    #       int64_list {
    #         value: 0
    #         value: 1
    #       }
    #     }
    #   }
    #   feature {
    #     key: &quot;input_mask&quot;
    #     value {
    #       int64_list {
    #         value: 0
    #         value: 0
    #       }
    #     }
    #   }
    # }
    tf_example = tf.train.Example(features=tf.train.Features(feature=features))
    #序列化之后（转换为二进制流）写入TFRecord
    writer.write(tf_example.SerializeToString())
  writer.close()
</code></pre>
<p>该函数用于将每个样本的特征写入TFRecord留底。<br>关于TFRecord，我找到了一篇比较简洁明了的博文 <a href="https://www.cnblogs.com/yanshw/p/12419616.html" target="_blank" rel="noopener">https://www.cnblogs.com/yanshw/p/12419616.html</a> 。</p>
<h2 id="file-based-input-fn-builder"><a href="#file-based-input-fn-builder" class="headerlink" title="file_based_input_fn_builder"></a>file_based_input_fn_builder</h2><pre><code class="python">def file_based_input_fn_builder(input_file, seq_length, is_training,
                                drop_remainder):
  &quot;&quot;&quot;Creates an `input_fn` closure to be passed to TPUEstimator.&quot;&quot;&quot;
  name_to_features = {
      &quot;input_ids&quot;: tf.FixedLenFeature([seq_length], tf.int64),
      &quot;input_mask&quot;: tf.FixedLenFeature([seq_length], tf.int64),
      &quot;segment_ids&quot;: tf.FixedLenFeature([seq_length], tf.int64),
      &quot;label_ids&quot;: tf.FixedLenFeature([], tf.int64),
      &quot;is_real_example&quot;: tf.FixedLenFeature([], tf.int64),
  }
  def _decode_record(record, name_to_features):
    &quot;&quot;&quot;Decodes a record to a TensorFlow example.&quot;&quot;&quot;
    example = tf.parse_single_example(record, name_to_features)
    # tf.Example only supports tf.int64, but the TPU only supports tf.int32.
    # So cast all int64 to int32.
    for name in list(example.keys()):
      t = example[name]
      if t.dtype == tf.int64:
        t = tf.to_int32(t)
      example[name] = t
    return example
  def input_fn(params):
    &quot;&quot;&quot;The actual input function.&quot;&quot;&quot;
    batch_size = params[&quot;batch_size&quot;]
    # For training, we want a lot of parallel reading and shuffling.
    # For eval, we want no shuffling and parallel reading doesn&#39;t matter.
    d = tf.data.TFRecordDataset(input_file)
    if is_training:
      d = d.repeat()
      d = d.shuffle(buffer_size=100)
    d = d.apply(
        tf.contrib.data.map_and_batch(
            lambda record: _decode_record(record, name_to_features),
            batch_size=batch_size,
            drop_remainder=drop_remainder))
    return d
  return input_fn
</code></pre>
<p>* 该函数用于基于文件将输入函数传入TPU，有关TPU的部分先搁置。</p>
<h2 id="truncate-seq-pair"><a href="#truncate-seq-pair" class="headerlink" title="_truncate_seq_pair"></a>_truncate_seq_pair</h2><pre><code class="python">def _truncate_seq_pair(tokens_a, tokens_b, max_length):
  &quot;&quot;&quot;Truncates a sequence pair in place to the maximum length.&quot;&quot;&quot;
  # This is a simple heuristic which will always truncate the longer sequence
  # one token at a time. This makes more sense than truncating an equal percent
  # of tokens from each, since if one sequence is very short then each token
  # that&#39;s truncated likely contains more information than a longer sequence.
  while True:
    total_length = len(tokens_a) + len(tokens_b)
    # 若总长小于等于最大长度则跳出循环
    if total_length &lt;= max_length:
      break
    # 若总长大于最大长度，
    # 则根据句子对的长短依次pop超出的部分直到符合要求。
    if len(tokens_a) &gt; len(tokens_b):
      tokens_a.pop()
    else:
      tokens_b.pop()
</code></pre>
<p>该函数用于处理句子对输入时，总长超出最大长度的情况。</p>
<h2 id="create-model"><a href="#create-model" class="headerlink" title="create_model"></a>create_model</h2><pre><code class="python">def create_model(bert_config, is_training, input_ids, input_mask, segment_ids,
                 labels, num_labels, use_one_hot_embeddings):
  &quot;&quot;&quot;Creates a classification model.&quot;&quot;&quot;
  # 初始化一个BERT模型
  model = modeling.BertModel(
      config=bert_config,
      is_training=is_training,
      input_ids=input_ids,
      input_mask=input_mask,
      token_type_ids=segment_ids,
      use_one_hot_embeddings=use_one_hot_embeddings)
  # In the demo, we are doing a simple classification task on the entire
  # segment.
  #
  # If you want to use the token-level output, use model.get_sequence_output()
  # instead.
  # 输出定义为pooling后的输出
  output_layer = model.get_pooled_output()
  hidden_size = output_layer.shape[-1].value
  # 生成一个对应输出层的截断正态分布的参数矩阵（标准差为0.02）
  output_weights = tf.get_variable(
      &quot;output_weights&quot;, [num_labels, hidden_size],
      initializer=tf.truncated_normal_initializer(stddev=0.02))
  # 偏置设为0
  output_bias = tf.get_variable(
      &quot;output_bias&quot;, [num_labels], initializer=tf.zeros_initializer())
  with tf.variable_scope(&quot;loss&quot;):
    if is_training:
      # I.e., 0.1 dropout
      # 为了减弱过拟合，将dropout的保持概率设为0.9
      output_layer = tf.nn.dropout(output_layer, keep_prob=0.9)
    # W_t * x + b 输出未归一化的“概率”logits，对应num_labels个label
    logits = tf.matmul(output_layer, output_weights, transpose_b=True)
    logits = tf.nn.bias_add(logits, output_bias)
    # 将digits经过softmax后得到对应num_labels个label的归一化输出
    probabilities = tf.nn.softmax(logits, axis=-1)
    log_probs = tf.nn.log_softmax(logits, axis=-1)
    # 为了计算样本误差，将label进行one-hot编码
    one_hot_labels = tf.one_hot(labels, depth=num_labels, dtype=tf.float32)
    # 计算每个样本对应标签的误差
    per_example_loss = -tf.reduce_sum(one_hot_labels * log_probs, axis=-1)
    # 得到平均误差（应该是交叉熵）
    loss = tf.reduce_mean(per_example_loss)
    # 返回平均误差loss，包含每个对应label误差的样本误差per_example_loss，未归一化的概率logits，归一化后的概率probabilities。
    return (loss, per_example_loss, logits, probabilities)
</code></pre>
<p>该函数借助model.py的一些参数和方法建立了一个基于BERT模型的encoder + 单层神经网络分类器，是run_classifier.py算法实现的核心框架部分。<br>关于dropout的源码解释，参考 <a href="https://blog.csdn.net/qq_20412595/article/details/82824830" target="_blank" rel="noopener">https://blog.csdn.net/qq_20412595/article/details/82824830</a> 。<br>关于logits和softmax的理解，参考 <a href="https://www.zhihu.com/question/60751553" target="_blank" rel="noopener">https://www.zhihu.com/question/60751553</a> 。</p>
<h2 id="model-fn-builder"><a href="#model-fn-builder" class="headerlink" title="model_fn_builder"></a>model_fn_builder</h2><pre><code class="python">def model_fn_builder(bert_config, num_labels, init_checkpoint, learning_rate,
                     num_train_steps, num_warmup_steps, use_tpu,
                     use_one_hot_embeddings):
  &quot;&quot;&quot;Returns `model_fn` closure for TPUEstimator.&quot;&quot;&quot;
  def model_fn(features, labels, mode, params):  # pylint: disable=unused-argument
    &quot;&quot;&quot;The `model_fn` for TPUEstimator.&quot;&quot;&quot;
    tf.logging.info(&quot;*** Features ***&quot;)
    for name in sorted(features.keys()):
      tf.logging.info(&quot;  name = %s, shape = %s&quot; % (name, features[name].shape))
    input_ids = features[&quot;input_ids&quot;]
    input_mask = features[&quot;input_mask&quot;]
    segment_ids = features[&quot;segment_ids&quot;]
    label_ids = features[&quot;label_ids&quot;]
    is_real_example = None
    if &quot;is_real_example&quot; in features:
      is_real_example = tf.cast(features[&quot;is_real_example&quot;], dtype=tf.float32)
    else:
      is_real_example = tf.ones(tf.shape(label_ids), dtype=tf.float32)
    is_training = (mode == tf.estimator.ModeKeys.TRAIN)
    (total_loss, per_example_loss, logits, probabilities) = create_model(
        bert_config, is_training, input_ids, input_mask, segment_ids, label_ids,
        num_labels, use_one_hot_embeddings)
    tvars = tf.trainable_variables()
    initialized_variable_names = {}
    scaffold_fn = None
    if init_checkpoint:
      (assignment_map, initialized_variable_names
      ) = modeling.get_assignment_map_from_checkpoint(tvars, init_checkpoint)
      if use_tpu:
        def tpu_scaffold():
          tf.train.init_from_checkpoint(init_checkpoint, assignment_map)
          return tf.train.Scaffold()
        scaffold_fn = tpu_scaffold
      else:
        tf.train.init_from_checkpoint(init_checkpoint, assignment_map)
    tf.logging.info(&quot;**** Trainable Variables ****&quot;)
    for var in tvars:
      init_string = &quot;&quot;
      if var.name in initialized_variable_names:
        init_string = &quot;, *INIT_FROM_CKPT*&quot;
      tf.logging.info(&quot;  name = %s, shape = %s%s&quot;, var.name, var.shape,
                      init_string)
    output_spec = None
    if mode == tf.estimator.ModeKeys.TRAIN:
      train_op = optimization.create_optimizer(
          total_loss, learning_rate, num_train_steps, num_warmup_steps, use_tpu)
      output_spec = tf.contrib.tpu.TPUEstimatorSpec(
          mode=mode,
          loss=total_loss,
          train_op=train_op,
          scaffold_fn=scaffold_fn)
    elif mode == tf.estimator.ModeKeys.EVAL:
      def metric_fn(per_example_loss, label_ids, logits, is_real_example):
        predictions = tf.argmax(logits, axis=-1, output_type=tf.int32)
        accuracy = tf.metrics.accuracy(
            labels=label_ids, predictions=predictions, weights=is_real_example)
        loss = tf.metrics.mean(values=per_example_loss, weights=is_real_example)
        return {
            &quot;eval_accuracy&quot;: accuracy,
            &quot;eval_loss&quot;: loss,
        }
      eval_metrics = (metric_fn,
                      [per_example_loss, label_ids, logits, is_real_example])
      output_spec = tf.contrib.tpu.TPUEstimatorSpec(
          mode=mode,
          loss=total_loss,
          eval_metrics=eval_metrics,
          scaffold_fn=scaffold_fn)
    else:
      output_spec = tf.contrib.tpu.TPUEstimatorSpec(
          mode=mode,
          predictions={&quot;probabilities&quot;: probabilities},
          scaffold_fn=scaffold_fn)
    return output_spec
  return model_fn
</code></pre>
<p>* 该函数用于建立BERT分类模型并将参数传入TPU，有关TPU的部分先搁置。</p>
<h2 id="input-fn-builder"><a href="#input-fn-builder" class="headerlink" title="input_fn_builder"></a>input_fn_builder</h2><pre><code class="python">def input_fn_builder(features, seq_length, is_training, drop_remainder):
  &quot;&quot;&quot;Creates an `input_fn` closure to be passed to TPUEstimator.&quot;&quot;&quot;
  all_input_ids = []
  all_input_mask = []
  all_segment_ids = []
  all_label_ids = []
  for feature in features:
    all_input_ids.append(feature.input_ids)
    all_input_mask.append(feature.input_mask)
    all_segment_ids.append(feature.segment_ids)
    all_label_ids.append(feature.label_id)
  def input_fn(params):
    &quot;&quot;&quot;The actual input function.&quot;&quot;&quot;
    batch_size = params[&quot;batch_size&quot;]
    num_examples = len(features)
    # This is for demo purposes and does NOT scale to large data sets. We do
    # not use Dataset.from_generator() because that uses tf.py_func which is
    # not TPU compatible. The right way to load data is with TFRecordReader.
    d = tf.data.Dataset.from_tensor_slices({
        &quot;input_ids&quot;:
            tf.constant(
                all_input_ids, shape=[num_examples, seq_length],
                dtype=tf.int32),
        &quot;input_mask&quot;:
            tf.constant(
                all_input_mask,
                shape=[num_examples, seq_length],
                dtype=tf.int32),
        &quot;segment_ids&quot;:
            tf.constant(
                all_segment_ids,
                shape=[num_examples, seq_length],
                dtype=tf.int32),
        &quot;label_ids&quot;:
            tf.constant(all_label_ids, shape=[num_examples], dtype=tf.int32),
    })
    if is_training:
      d = d.repeat()
      d = d.shuffle(buffer_size=100)
    d = d.batch(batch_size=batch_size, drop_remainder=drop_remainder)
    return d
  return input_fn
</code></pre>
<p>* 该函数用于不基于文件将输入函数传入TPU，有关TPU的部分先搁置。</p>
<h2 id="convert-examples-to-features"><a href="#convert-examples-to-features" class="headerlink" title="convert_examples_to_features"></a>convert_examples_to_features</h2><pre><code class="python">def convert_examples_to_features(examples, label_list, max_seq_length,
                                 tokenizer):
  &quot;&quot;&quot;Convert a set of `InputExample`s to a list of `InputFeatures`.&quot;&quot;&quot;
  features = []
  for (ex_index, example) in enumerate(examples):
    if ex_index % 10000 == 0:
      tf.logging.info(&quot;Writing example %d of %d&quot; % (ex_index, len(examples)))
    feature = convert_single_example(ex_index, example, label_list,
                                     max_seq_length, tokenizer)
    features.append(feature)
  return features
</code></pre>
<p>该函数用于批量将InputExample类转换为InputFeatures类。</p>
<h2 id="main"><a href="#main" class="headerlink" title="\main:"></a>\main:</h2><pre><code class="python">def main(_):
  # 将日志信息打印
  tf.logging.set_verbosity(tf.logging.INFO)

  # 建立关于数据处理器的字典
  processors = {
      &quot;cola&quot;: ColaProcessor,
      &quot;mnli&quot;: MnliProcessor,
      &quot;mrpc&quot;: MrpcProcessor,
      &quot;xnli&quot;: XnliProcessor,
  }

  # 验证do_lower_case的选择是否与checkpoint匹配
  tokenization.validate_case_matches_checkpoint(FLAGS.do_lower_case,
                                                FLAGS.init_checkpoint)

  # 保证至少在参数部分选择了train/eval/predict三个操作中的一种，否则报错
  if not FLAGS.do_train and not FLAGS.do_eval and not FLAGS.do_predict:
    raise ValueError(
        &quot;At least one of `do_train`, `do_eval` or `do_predict&#39; must be True.&quot;)

  # 输入BERT的配置文件
  bert_config = modeling.BertConfig.from_json_file(FLAGS.bert_config_file)

  # 如果参数部分设定的最大序列长度大于BERT的最大position embedding长度，则报错
  if FLAGS.max_seq_length &gt; bert_config.max_position_embeddings:
    raise ValueError(
        &quot;Cannot use sequence length %d because the BERT model &quot;
        &quot;was only trained up to sequence length %d&quot; %
        (FLAGS.max_seq_length, bert_config.max_position_embeddings))

  # 创建参数设定的输出目录
  tf.gfile.MakeDirs(FLAGS.output_dir)

  # 传入任务名称
  task_name = FLAGS.task_name.lower()

  # 若任务不在数据处理器的字典中，则报错
  if task_name not in processors:
    raise ValueError(&quot;Task not found: %s&quot; % (task_name))

  # 选择对应任务的数据处理器
  processor = processors[task_name]()

  # 传入数据处理器处理后的标签列表
  label_list = processor.get_labels()

  # 选择使用FullTokenizer分词，选择词典和是否小写
  tokenizer = tokenization.FullTokenizer(
      vocab_file=FLAGS.vocab_file, do_lower_case=FLAGS.do_lower_case)

  # TPU参数初始化
  tpu_cluster_resolver = None
  if FLAGS.use_tpu and FLAGS.tpu_name:
    tpu_cluster_resolver = tf.contrib.cluster_resolver.TPUClusterResolver(
        FLAGS.tpu_name, zone=FLAGS.tpu_zone, project=FLAGS.gcp_project)
  is_per_host = tf.contrib.tpu.InputPipelineConfig.PER_HOST_V2

  # TPU配置设定
  run_config = tf.contrib.tpu.RunConfig(
      cluster=tpu_cluster_resolver,
      master=FLAGS.master,
      model_dir=FLAGS.output_dir,
      save_checkpoints_steps=FLAGS.save_checkpoints_steps,
      tpu_config=tf.contrib.tpu.TPUConfig(
          iterations_per_loop=FLAGS.iterations_per_loop,
          num_shards=FLAGS.num_tpu_cores,
          per_host_input_for_training=is_per_host))

  train_examples = None
  num_train_steps = None
  num_warmup_steps = None

  # 训练部分初始化参数
  if FLAGS.do_train:
    # 通过数据处理器的函数获得训练样本
    train_examples = processor.get_train_examples(FLAGS.data_dir)
    # 实际训练步数 = 训练样本总数 / 批大小 * 训练轮数
    num_train_steps = int(
        len(train_examples) / FLAGS.train_batch_size * FLAGS.num_train_epochs)
    # warmup步数 = 实际训练步数 * 热身比例
    num_warmup_steps = int(num_train_steps * FLAGS.warmup_proportion)

  # BERT建模 
  model_fn = model_fn_builder(
      bert_config=bert_config,
      num_labels=len(label_list),
      init_checkpoint=FLAGS.init_checkpoint,
      learning_rate=FLAGS.learning_rate,
      num_train_steps=num_train_steps,
      num_warmup_steps=num_warmup_steps,
      use_tpu=FLAGS.use_tpu,
      use_one_hot_embeddings=FLAGS.use_tpu)
  # If TPU is not available, this will fall back to normal Estimator on CPU
  # or GPU.

  # 配置TPUEstimator（若没有TPU，则会使用CPU/GPU）
  estimator = tf.contrib.tpu.TPUEstimator(
      use_tpu=FLAGS.use_tpu,
      model_fn=model_fn,
      config=run_config,
      train_batch_size=FLAGS.train_batch_size,
      eval_batch_size=FLAGS.eval_batch_size,
      predict_batch_size=FLAGS.predict_batch_size)

  # 训练部分主题
  if FLAGS.do_train:
    # 指定输出训练数据的TFRecord文件的位置
    train_file = os.path.join(FLAGS.output_dir, &quot;train.tf_record&quot;)
    # 批量将样本转化为包含features的TFRecord文件
    file_based_convert_examples_to_features(
        train_examples, label_list, FLAGS.max_seq_length, tokenizer, train_file)
    # 打印样本总数、批大小、实际训练步数
    tf.logging.info(&quot;***** Running training *****&quot;)
    tf.logging.info(&quot;  Num examples = %d&quot;, len(train_examples))
    tf.logging.info(&quot;  Batch size = %d&quot;, FLAGS.train_batch_size)
    tf.logging.info(&quot;  Num steps = %d&quot;, num_train_steps)
    # 基于文件解包并生成传入TPUEstimator的包含features的输入函数
    train_input_fn = file_based_input_fn_builder(
        input_file=train_file,
        seq_length=FLAGS.max_seq_length,
        is_training=True,
        drop_remainder=True)
    # 将features和实际训练步数传入TPUEstimator并开始训练
    estimator.train(input_fn=train_input_fn, max_steps=num_train_steps)

  # 评估阶段
  if FLAGS.do_eval:
    # 数据处理器获取评估集样本
    eval_examples = processor.get_dev_examples(FLAGS.data_dir)
    # 评估集样本个数
    num_actual_eval_examples = len(eval_examples)
    # 如果使用TPU
    if FLAGS.use_tpu:
      # TPU requires a fixed batch size for all batches, therefore the number
      # of examples must be a multiple of the batch size, or else examples
      # will get dropped. So we pad with fake examples which are ignored
      # later on. These do NOT count towards the metric (all tf.metrics
      # support a per-instance weight, and these get a weight of 0.0).
      # 如果（样本个数 / 批大小）不整除，则做padding充数使其可被整除
      while len(eval_examples) % FLAGS.eval_batch_size != 0:
        eval_examples.append(PaddingInputExample())
    # 建立评估TFRecord文件的目录
    eval_file = os.path.join(FLAGS.output_dir, &quot;eval.tf_record&quot;)
    # 批量将样本转化为包含features的TFRecord文件
    file_based_convert_examples_to_features(
        eval_examples, label_list, FLAGS.max_seq_length, tokenizer, eval_file)
    # 打印实际样本个数、padding的样本个数、批大小
    tf.logging.info(&quot;***** Running evaluation *****&quot;)
    tf.logging.info(&quot;  Num examples = %d (%d actual, %d padding)&quot;,
                    len(eval_examples), num_actual_eval_examples,
                    len(eval_examples) - num_actual_eval_examples)
    tf.logging.info(&quot;  Batch size = %d&quot;, FLAGS.eval_batch_size)
    # This tells the estimator to run through the entire set.
    eval_steps = None
    # However, if running eval on the TPU, you will need to specify the
    # number of steps.
    # 如果使用TPU，需要确定评估阶段的步数。
    if FLAGS.use_tpu:
      # 断言函数确保（样本个数 / 批大小）整除，否则报错。
      assert len(eval_examples) % FLAGS.eval_batch_size == 0
      # 实际评估步数即为整除后的得到的整数
      # 可以看到这里写程序的同学十分谨慎，既用了整除“//”，又强制转换了类型为整型
      eval_steps = int(len(eval_examples) // FLAGS.eval_batch_size)
    # 如果使用TPU则用drop_remainder，否则不用。
    eval_drop_remainder = True if FLAGS.use_tpu else False
    # 基于文件解包并生成传入TPUEstimator的包含features的输入函数
    eval_input_fn = file_based_input_fn_builder(
        input_file=eval_file,
        seq_length=FLAGS.max_seq_length,
        is_training=False,
        drop_remainder=eval_drop_remainder)
    # 将features和实际评估步数传入TPUEstimator并开始评估
    result = estimator.evaluate(input_fn=eval_input_fn, steps=eval_steps)
    # 创建评估结果的txt文档
    output_eval_file = os.path.join(FLAGS.output_dir, &quot;eval_results.txt&quot;)
    # 向评估结果的txt文档写入result返回的四个参数
    # eval_accuracy、eval_loss、global_step、loss
    # *目前不知道这几个参数的具体含义，需要进一步查看estimator.evaluate返回的参数是如何定义的。
    with tf.gfile.GFile(output_eval_file, &quot;w&quot;) as writer:
      tf.logging.info(&quot;***** Eval results *****&quot;)
      for key in sorted(result.keys()):
        # 屏幕打印
        tf.logging.info(&quot;  %s = %s&quot;, key, str(result[key]))
        # 写入txt文件
        writer.write(&quot;%s = %s\n&quot; % (key, str(result[key])))

  # 预测阶段
  if FLAGS.do_predict:
    # 传入预测样本
    predict_examples = processor.get_test_examples(FLAGS.data_dir)
    # 预测样本总数
    num_actual_predict_examples = len(predict_examples)
    # 如果使用TPU
    if FLAGS.use_tpu:
      # TPU requires a fixed batch size for all batches, therefore the number
      # of examples must be a multiple of the batch size, or else examples
      # will get dropped. So we pad with fake examples which are ignored
      # later on.
      # 若样本总数不能整除batch，则padding样本充数。
      while len(predict_examples) % FLAGS.predict_batch_size != 0:
        predict_examples.append(PaddingInputExample())
    # 创建TFRecord文件目录
    predict_file = os.path.join(FLAGS.output_dir, &quot;predict.tf_record&quot;)
    # 批量将样本转化为包含features的TFRecord文件
    file_based_convert_examples_to_features(predict_examples, label_list,
                                            FLAGS.max_seq_length, tokenizer,
                                            predict_file)
    # 打印实际样本数、padding样本数、批大小
    tf.logging.info(&quot;***** Running prediction*****&quot;)
    tf.logging.info(&quot;  Num examples = %d (%d actual, %d padding)&quot;,
                    len(predict_examples), num_actual_predict_examples,
                    len(predict_examples) - num_actual_predict_examples)
    tf.logging.info(&quot;  Batch size = %d&quot;, FLAGS.predict_batch_size)
    # 如果使用TPU则用drop_remainder，否则不用。
    predict_drop_remainder = True if FLAGS.use_tpu else False
    # 基于文件解包并生成传入TPUEstimator的包含features的输入函数
    predict_input_fn = file_based_input_fn_builder(
        input_file=predict_file,
        seq_length=FLAGS.max_seq_length,
        is_training=False,
        drop_remainder=predict_drop_remainder)
    # 开始预测
    result = estimator.predict(input_fn=predict_input_fn)
    # 创建预测结果的tsv文件
    output_predict_file = os.path.join(FLAGS.output_dir, &quot;test_results.tsv&quot;)
    # 写入tsv文件
    with tf.gfile.GFile(output_predict_file, &quot;w&quot;) as writer:
      num_written_lines = 0
      tf.logging.info(&quot;***** Predict results *****&quot;)
      # 按照标签顺序写入每个预测样本对应标签的概率
      # *需要进一步查看estimator.predict返回的数据是如何定义的
      for (i, prediction) in enumerate(result):
        probabilities = prediction[&quot;probabilities&quot;]
        if i &gt;= num_actual_predict_examples:
          break
        output_line = &quot;\t&quot;.join(
            str(class_probability)
            for class_probability in probabilities) + &quot;\n&quot;
        writer.write(output_line)
        num_written_lines += 1
    # 断言函数保证写入tsv的行数与预测样本总数相同，否则报错。
    assert num_written_lines == num_actual_predict_examples
</code></pre>
<p>主函数部分。</p>
<h2 id="if-name-“main“"><a href="#if-name-“main“" class="headerlink" title="if name == “main“:"></a>if <strong>name</strong> == “<strong>main</strong>“:</h2><pre><code class="python"># 主函数调用
if __name__ == &quot;__main__&quot;:
  # 将data_dir、task_name、vocab_file、bert_config_file、output_dir设置为必要参数
  flags.mark_flag_as_required(&quot;data_dir&quot;)
  flags.mark_flag_as_required(&quot;task_name&quot;)
  flags.mark_flag_as_required(&quot;vocab_file&quot;)
  flags.mark_flag_as_required(&quot;bert_config_file&quot;)
  flags.mark_flag_as_required(&quot;output_dir&quot;)
  # 该函数会先处理flag之后默认运行main函数
  tf.app.run()
</code></pre>
<p>flag处理以及主函数调用。<br>tf.app.run()的源码解释详见 <a href="https://blog.csdn.net/helei001/article/details/51859423" target="_blank" rel="noopener">https://blog.csdn.net/helei001/article/details/51859423</a></p>
<pre><code class="python">def run(main=None):
f = flags.FLAGS
f._parse_flags()
main = main or sys.modules[&#39;__main__&#39;].main
sys.exit(main(sys.argv))
</code></pre>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>run_classifier.py的代码官方给出了982行，我写这篇文章写了两天，前期准备不知道用了多久，因为一直在看这个分类器的代码。说实话准备充分的话看起来还是很轻松的，但几个月之前刚下BERT看这个分类器的代码的时候真的是一头雾水，即便我已经大致了解了BERT的实际工作原理。</p>
<p>还剩下一些关于TPUEstimator参数配置的部分没加注释，还有一些关于评估阶段测试阶段的result返回数据没确认。之后会继续补齐。</p>

        </div>
        <!-- .entry-content -->
        <!--<div class="single-reward">
          <div class="reward-open">赏
            <div class="reward-main">
              <ul class="reward-row">
                <li class="alipay-code"><img src="/img/custom/social/github.svg"></li>
                <li class="wechat-code"><img src="undefined"></li>
              </ul>
            </div>
          </div>
        </div>-->
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer><!-- .entry-footer -->
      </article>
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
          
            <div class="post-nepre half previous">
          
            <a href="/2020/11/30/「ロマンスの約束」歌词翻译/" rel="prev">
              <div class="background">
                <img class="lazyload" src="https://s1.ax1x.com/2020/07/13/UtQmM6.jpg,https://s1.ax1x.com/2020/07/13/UtQSMV.jpg,https://s1.ax1x.com/2020/07/03/NjoeaT.jpg,https://s1.ax1x.com/2020/07/03/NjIDET.jpg,https://s1.ax1x.com/2020/07/03/NjIXrt.jpg,https://s1.ax1x.com/2020/07/03/NjIb2d.jpg,https://s1.ax1x.com/2020/07/13/UtQVR1.jpg,https://s1.ax1x.com/2020/07/13/UtQ3id.jpg,https://s2.ax1x.com/2020/02/10/14XAGd.jpg" data-src="https://s2.ax1x.com/2020/02/10/14XAGd.jpg" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="https://s2.ax1x.com/2020/02/10/14XAGd.jpg">
              </div>
              <span class="label">
              Previous Post</span>
              <div class="info">
                <h3>
                「ロマンスの約束」歌词翻译</h3>
                <hr>
              </div>
            </a>
          </div>
        
        
          
            <div class="post-nepre half next">
          
            <a href="/2020/11/16/「深愛」歌词翻译/" rel="next">
              <div class="background">
                <img class="lazyload" src="https://s1.ax1x.com/2020/07/13/UtQmM6.jpg,https://s1.ax1x.com/2020/07/13/UtQSMV.jpg,https://s1.ax1x.com/2020/07/03/NjoeaT.jpg,https://s1.ax1x.com/2020/07/03/NjIDET.jpg,https://s1.ax1x.com/2020/07/03/NjIXrt.jpg,https://s1.ax1x.com/2020/07/03/NjIb2d.jpg,https://s1.ax1x.com/2020/07/13/UtQVR1.jpg,https://s1.ax1x.com/2020/07/13/UtQ3id.jpg,https://s2.ax1x.com/2020/02/10/14XAGd.jpg" data-src="https://s2.ax1x.com/2020/02/10/14XAGd.jpg" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="https://s2.ax1x.com/2020/02/10/14XAGd.jpg">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                「深愛」 歌词翻译</h3>
                <hr>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "lYNRGPGqY6jaXXBdu5JwvBHN-MdYXbMMI",
        appKey: "wJkDCj8fLwzhY7dC7QXfQe1V",
        path: window.location.pathname,
        placeholder: "欢迎在评论区留言！",
        recordIP: true
      })
  }
</script>


      <!-- -->
      <section class="author-profile">
        <div class="info" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <a href="" class="profile gravatar"><img src="https://s2.ax1x.com/2020/02/10/14XAGd.jpg" itemprop="image" alt="彩音" height="70" width="70"></a>
          <div class="meta">
            <span class="title">Author</span>
            <h3 itemprop="name">
            <a href="" itemprop="url" rel="author">彩音</a>
            </h3>
          </div>
        </div>
        <hr>
        <p><i class="iconfont icon-write"></i>喵喵喵？</p>
      </section>
    </main><!-- #main -->
  </div><!-- #primary -->
</div>

<!--  -->

    </div>  
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            // PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 彩音<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2019-2022 Yuk1n0sh1ta</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;">Theme <a href="https://github.com/honjun/hexo-theme-sakura" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Sakura</a> <i class="iconfont icon-sakura rotating" style="color: #ffc0cb;display:inline-block"></i> by <a href="https://2heng.xin/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Mashiro</a>&<a href="https://www.hojun.cn/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Hojun</a>, Powered by Hexo, Modified by Yuk1n0, Hosted by Github & Gitee</a>
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<!--<script src='//unpkg.com/valine@1.3.4/dist/Valine.min.js'></script> Modified by Yuk1n0-->
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script src="/js/botui.js"></script>
<!-- 不蒜子 网页计数器 -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"0","movies":{"url": "","name":"","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"0","movies":{"url": "","name":"","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //有图的情况
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>


<!--Updated by Yuk1n0 -->
<script type="text/javascript" src="https://lib.baomitu.com/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
  </script>

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <div id="mo-nav" class="">
  <div class="m-avatar">
    <img src="https://s2.ax1x.com/2020/02/10/14XAGd.jpg">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">桜の彩音</p>
  <p style="text-align: center; word-spacing: 20px;">
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            首页
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            归档
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/学习/">
                  <i class="fa fa-code" aria-hidden="true"></i>
                  学习
                </a>
              </li>
            
              <li>
                <a href="/categories/生活/">
                  <i class="fa fa-file-text-o" aria-hidden="true"></i>
                  生活
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
            清单
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/musiclist/">
                  <i class="fa fa-headphones" aria-hidden="true"></i>
                  歌单
                </a>
              </li>
            
              <li>
                <a href="/gallery/">
                  <i class="fa fa-photo" aria-hidden="true"></i>
                  美术
                </a>
              </li>
            
              <li>
                <a href="/photo/">
                  <i class="fa fa-film" aria-hidden="true"></i>
                  相册
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
            关于
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/about/">
                  <i class="fa fa-meetup" aria-hidden="true"></i>
                  我
                </a>
              </li>
            
          </ul>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2019-2022 Yuk1n0sh1ta</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="\css\APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
<style>
  .aplayer .aplayer-list ol li.aplayer-list-light{
    background: rgba(101, 179, 253, 0.2);
  }
  .aplayer.aplayer-fixed{
    bottom: 72px;
    background: rgba(255, 255, 255, 0.65);
    -moz-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
    -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
    width: 400;
  }
  .aplayer.aplayer-fixed .aplayer-body{
    bottom: 72px;
    background: rgba(255, 255, 255, 0.2);
    -moz-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
    -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
    width: 400;
  }
  .aplayer .aplayer-lrc {
    height: 44px;
    width: 100%;
  }
  .aplayer .aplayer-lrc p{
    font-family:'Courier New', Courier, monospace;
    text-shadow: 0.5px 0.5px 1px black;
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 1px;
    line-height: 130% !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: rgb(98, 109, 255);
  }
  .aplayer.aplayer-narrow .aplayer-body{
    bottom: 5px;
    -moz-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
    -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer.aplayer-narrow .lrc-show {
    height: 54px;
    width: 70%;
    display: inherit;
    left: 15%;
    margin-left: 40px;
    background: rgba(255, 255, 255, 0.1);
    -moz-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
    -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
  }
  .aplayer.aplayer.aplayer-fixed .lrc-show {
    height: 54px;
    width: 70%;
    display: inherit;
    left: 15%;
    margin-left: 40px;
    background: rgba(255, 255, 255, 0.1);
    -moz-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
    -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
  }
  
</style>
<meting-js

    id="2017848421"

    server="netease"

    type="playlist"

    fixed="true"

    autoplay="false"

    loop="all"

    order="random"

    preload="auto"

    volume="0.7"

    mutex="true"

    theme="#2980b9"

</meting-js>
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-icon.aplayer-icon-lrc').hasClass('aplayer-icon-lrc-inactivity')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      }
      else if($('.aplayer').hasClass('aplayer-withlrc')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } 
      else {
        if($('.aplayer-button').hasClass('aplayer-pause')) {
        $('.aplayer-lrc').addClass('lrc-show');
        }
      }
    })
  });
  
</script>
</body>
</html>